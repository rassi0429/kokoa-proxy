# Kokoa Proxy - 設計・仕様策定チェックリスト

> このドキュメントは実装前に固めるべき設計項目のチェックリストです。
> 各項目を順次埋めていき、仕様を確定させます。

---

## 1. ユースケース定義

### アクター（登場人物）

- [ ] **システム管理者（Primary Admin）**
  - 役割:
  - 権限:
  - 主な操作:

- [ ] **運用担当者（Operator）**
  - 役割:
  - 権限:
  - 主な操作:

- [ ] **エンドユーザー**
  - 役割:
  - システムとの関わり:

- [ ] **システム（自動処理）**
  - 自動実行されるタスク:

### 主要ユースケース

- [ ] **UC-001: 初回セットアップ**
  - 前提条件:
  - 成功シナリオ:
  - 代替シナリオ:
  - 例外処理:

- [ ] **UC-002: エッジノード追加**
  - 前提条件:
  - 成功シナリオ:
  - 代替シナリオ:
  - 例外処理:

- [ ] **UC-003: エッジノード削除**
  - 前提条件:
  - 成功シナリオ:
  - 代替シナリオ:
  - 例外処理:

- [ ] **UC-004: 障害検知・自動フェイルオーバー**
  - 前提条件:
  - 成功シナリオ:
  - 代替シナリオ:
  - 例外処理:

- [ ] **UC-005: 攻撃時のノード緊急交換**
  - 前提条件:
  - 成功シナリオ:
  - 代替シナリオ:
  - 例外処理:

- [ ] **UC-006: SSL証明書更新**
  - 前提条件:
  - 成功シナリオ:
  - 代替シナリオ:
  - 例外処理:

- [ ] **UC-007: 設定変更・再配布**
  - 前提条件:
  - 成功シナリオ:
  - 代替シナリオ:
  - 例外処理:

- [ ] **UC-008: ログ・監視確認**
  - 前提条件:
  - 成功シナリオ:
  - 代替シナリオ:
  - 例外処理:

### ユーザーストーリー

- [ ] 管理者として、攻撃を受けたノードを**5分以内**に交換したい
- [ ] 管理者として、新しいWebサービスを**10分以内**に公開したい
- [ ] 管理者として、ノードの稼働状況を**リアルタイム**で確認したい
- [ ] 管理者として、過去のトラフィックログを**簡単に検索**したい
- [ ] 管理者として、コストを**可視化**して最適化したい
- [ ] システムとして、ノード障害を**30秒以内**に検知したい
- [ ] システムとして、障害ノードを**自動的にDNSから除外**したい
- [ ] （追加のストーリー...）

---

## 2. 機能要件

### MUST（必須機能）

#### Control Plane
- [ ] Web UI/API提供
- [ ] オリジンサーバー登録・管理
- [ ] エッジノード登録・管理
- [ ] WireGuard設定自動生成
- [ ] Nginx/Traefik設定自動生成
- [ ] ヘルスチェック機能
- [ ] 基本的な認証（パスワード）
- [ ] ノード一覧表示
- [ ] 基本的なログ記録

#### Edge Node
- [ ] WireGuardトンネル確立
- [ ] リバースプロキシ（Nginx/Traefik）
- [ ] SSL/TLS終端
- [ ] ヘルスチェックエンドポイント
- [ ] Control Planeへのハートビート送信
- [ ] 基本的なrate limiting

#### Origin Server
- [ ] WireGuard Server動作
- [ ] 複数エッジノードの受け入れ
- [ ] バックエンドアプリへのプロキシ
- [ ] Control Planeへの状態報告

### SHOULD（推奨機能）

- [ ] DNS自動更新（Cloudflare/Route53 API）
- [ ] VPS自動作成（DigitalOcean/Vultr API）
- [ ] 自動フェイルオーバー
- [ ] SSL証明書自動取得・更新（Let's Encrypt）
- [ ] リアルタイム監視ダッシュボード
- [ ] アラート通知（Email/Slack/Discord）
- [ ] トラフィック統計・グラフ
- [ ] 2FA（TOTP）
- [ ] アクセスログの保存・検索
- [ ] 設定のバックアップ・リストア

### COULD（将来的な機能）

- [ ] SSO統合（OAuth2/OIDC）
- [ ] 複数オリジンサーバー対応
- [ ] チーム管理・権限制御（RBAC）
- [ ] カスタムプラグイン機能
- [ ] Kubernetes統合
- [ ] Terraformプロバイダー
- [ ] CLIツール
- [ ] モバイルアプリ
- [ ] 予算管理・コストアラート
- [ ] A/Bテスト機能
- [ ] カナリアデプロイ

---

## 3. 非機能要件

### パフォーマンス

- [ ] **レイテンシ**
  - Control Plane API応答時間: 目標値 ___ ms
  - Edge → Origin プロキシレイテンシ: 目標値 ___ ms
  - ヘルスチェック間隔: ___ 秒
  - DNS TTL: ___ 秒

- [ ] **スループット**
  - 1エッジノードあたりの同時接続数: ___ 接続
  - Control Plane同時API呼び出し数: ___ req/s
  - 最大管理可能エッジノード数: ___ 台

- [ ] **リソース使用量**
  - Control Plane: CPU ___ core, Memory ___ GB
  - Edge Node: CPU ___ core, Memory ___ GB
  - Origin Server追加オーバーヘッド: ___

### 可用性（Availability）

- [ ] **SLA目標**: ___% (例: 99.9% = 月間43分ダウン許容)
- [ ] **RPO（目標復旧時点）**: ___ (例: 1時間前のバックアップ)
- [ ] **RTO（目標復旧時間）**: ___ (例: 5分以内に復旧)
- [ ] **MTTR（平均復旧時間）**: ___ (例: 3分)
- [ ] **MTBF（平均故障間隔）**: ___ (例: 30日)

- [ ] **単一障害点の特定**
  - Control Plane: 対策 ___
  - Origin Server: 対策 ___
  - DNS Provider: 対策 ___

### セキュリティ

- [ ] **脅威モデル**
  - 想定する攻撃者: ___
  - 想定する攻撃: DDoS, データ漏洩, 不正アクセス, ___
  - 保護すべき資産: ___

- [ ] **認証・認可**
  - Control Plane Web UI: ___ (例: Email/Password + TOTP)
  - API: ___ (例: JWT Bearer Token)
  - Node間通信: ___ (例: WireGuard + Node Token)

- [ ] **暗号化**
  - ユーザー → Edge: ___ (例: TLS 1.3)
  - Edge → Origin: ___ (例: WireGuard)
  - Control Plane ↔ Node: ___ (例: HTTPS + mTLS)
  - DB内の秘密情報: ___ (例: AES-256)

- [ ] **DDoS対策**
  - Layer 3/4: ___ (例: VPSプロバイダー任せ)
  - Layer 7: ___ (例: Nginx rate limiting)
  - 自動検知閾値: ___
  - 自動対応: ___ (例: DNS除外 → VPS削除)

- [ ] **脆弱性対策**
  - 依存パッケージの自動更新: ___
  - セキュリティスキャン: ___
  - ペネトレーションテスト: ___

### スケーラビリティ

- [ ] **水平スケーリング**
  - Edge Node: ___ 台まで対応
  - Control Plane: ___ (例: 単一インスタンス / 冗長化)
  - Origin Server: ___ (例: 単一 / クラスタ)

- [ ] **垂直スケーリング**
  - データベース最大サイズ: ___ GB
  - ログ保存期間: ___ 日
  - 履歴データの圧縮・アーカイブ: ___

### 保守性・運用性

- [ ] **モニタリング**
  - メトリクス収集: ___ (例: Prometheus)
  - ログ集約: ___ (例: Loki / ELK)
  - トレーシング: ___ (例: 不要 / Jaeger)

- [ ] **バックアップ**
  - 対象: ___ (例: DB, 設定ファイル, WireGuard鍵)
  - 頻度: ___ (例: 日次)
  - 保存先: ___ (例: S3互換ストレージ)
  - リストア手順: ___

- [ ] **アップデート戦略**
  - Control Plane: ___ (例: Blue-Greenデプロイ)
  - Edge Node: ___ (例: ローリングアップデート)
  - ダウンタイム: ___ (例: ゼロダウンタイム目標)

---

## 4. UI/UXフロー

### 画面一覧

- [ ] **ログイン画面**
  - 入力項目:
  - バリデーション:
  - エラー表示:

- [ ] **ダッシュボード**
  - 表示情報:
  - 更新頻度:
  - アクション:

- [ ] **オリジン管理画面**
  - 一覧表示項目:
  - 詳細表示項目:
  - 操作ボタン:

- [ ] **エッジノード管理画面**
  - 一覧表示項目:
  - 詳細表示項目:
  - 操作ボタン:

- [ ] **ノード追加ウィザード**
  - ステップ1:
  - ステップ2:
  - ステップ3:
  - 確認画面:

- [ ] **設定画面**
  - 一般設定:
  - DNS設定:
  - SSL設定:
  - アラート設定:

- [ ] **ログ・監視画面**
  - フィルター項目:
  - 表示項目:
  - エクスポート機能:

### 操作フロー詳細

- [ ] **エッジノード追加フロー**
  ```
  1. [Add Edge Node] ボタンクリック
  2. プロバイダー選択（DigitalOcean / Vultr / Manual）
  3. リージョン選択
  4. サイズ選択
  5. SSH鍵選択 or アップロード
  6. [Create] クリック
  7. プログレス表示（VPS作成中...）
  8. 完了通知
  9. ノード一覧に追加表示
  ```

- [ ] **障害検知時のUX**
  ```
  1. システムが異常検知
  2. ダッシュボードに警告バッジ表示
  3. アラート通知送信（Email/Slack）
  4. 管理者がダッシュボード確認
  5. 詳細モーダル表示（エラー内容、推奨アクション）
  6. [Auto Fix] or [Manual Fix] 選択
  7. 実行ログのリアルタイム表示
  8. 完了通知
  ```

### エラー時のUX

- [ ] **ネットワークエラー**
  - 表示方法: ___
  - リトライ機能: ___
  - ユーザーアクション: ___

- [ ] **バリデーションエラー**
  - 表示タイミング: ___
  - 表示位置: ___
  - エラーメッセージ: ___

- [ ] **サーバーエラー**
  - 表示方法: ___
  - ログ記録: ___
  - サポート連絡先: ___

---

## 5. データフロー・状態遷移

### エッジノードのライフサイクル

```
[状態遷移図]

(作成要求) → [PROVISIONING] → (VPS起動完了) → [CONFIGURING]
                                                      ↓
                                                  (設定完了)
                                                      ↓
                                              [TUNNEL_CONNECTING]
                                                      ↓
                                              (トンネル確立)
                                                      ↓
                ┌──────────────────────→ [ACTIVE] ←──┘
                │                           │  │
                │                           │  │ (ヘルスチェック失敗)
                │                           │  ↓
                │                           │ [UNHEALTHY]
                │                           │  │
                │                           │  │ (3回連続失敗)
                │                           │  ↓
                │                           │ [DNS_REMOVING]
                │                           │  │
                │ (復旧)                    │  │ (DNS削除完了)
                └───────────────────────────┘  ↓
                                          [ISOLATED]
                                               │
                                               │ (削除要求)
                                               ↓
                                          [DELETING]
                                               │
                                               │ (VPS削除完了)
                                               ↓
                                          [DELETED]
```

- [ ] 各状態の詳細定義
  - PROVISIONING:
  - CONFIGURING:
  - TUNNEL_CONNECTING:
  - ACTIVE:
  - UNHEALTHY:
  - DNS_REMOVING:
  - ISOLATED:
  - DELETING:
  - DELETED:

### 設定の伝播フロー

```
[設定変更フロー]

1. 管理者 → Control Plane
   POST /api/v1/origins/{id}/config
   { "nginx_config": "..." }

2. Control Plane
   - 設定をバリデーション
   - DBに保存
   - 影響を受けるノードを特定

3. Control Plane → Edge Nodes
   - WebSocket経由で設定プッシュ
   - または、ノードからのポーリング

4. Edge Node
   - 設定を受信
   - バックアップ作成（/etc/backup/）
   - 設定ファイル更新
   - Nginx設定テスト (nginx -t)
   - テスト成功 → Nginxリロード
   - テスト失敗 → ロールバック + エラー報告

5. Edge Node → Control Plane
   - 適用結果を報告
   - POST /api/v1/heartbeat { "config_version": "v2" }

6. Control Plane
   - 全ノードの適用状況を集計
   - ダッシュボードに表示
```

- [ ] 設定バージョン管理の詳細
- [ ] ロールバック手順
- [ ] 部分適用失敗時の対応

### 障害検知から復旧までの状態遷移

```
[自動フェイルオーバーフロー]

T+0s    Edge Node 1のヘルスチェック失敗（1回目）
        → Control Planeがリトライ予約

T+5s    ヘルスチェック失敗（2回目）
        → 内部で「unhealthy候補」としてマーク

T+10s   ヘルスチェック失敗（3回目）
        → 状態を UNHEALTHY に変更
        → アラート送信（Slack/Email）
        → DNS削除ジョブをキューに追加

T+11s   DNS Provider APIコール
        → Aレコード削除
        → 状態を DNS_REMOVING に変更

T+12s   DNS削除完了確認
        → 状態を ISOLATED に変更
        → TTL期間（30秒）待機開始

T+42s   TTL期間終了
        → 新規トラフィックは全て他ノードへ
        → (オプション) VPS自動削除
        → 状態を DELETING → DELETED

並行処理:
T+10s   (オプション) 自動リプレース機能が有効な場合
        → 新しいエッジノード作成ジョブをキューに追加
        → 5分以内に新ノードが ACTIVE 状態に
```

- [ ] 各タイミングの詳細設定
- [ ] リトライロジック
- [ ] エスカレーション条件

---

## 6. エッジケース・異常系

### ネットワーク関連

- [ ] **ネットワーク分断時の挙動**
  - Edge ↔ Origin間が切断:
  - Control Plane ↔ Edge間が切断:
  - Control Plane ↔ Origin間が切断:
  - DNS Providerへの接続失敗:

- [ ] **WireGuardトンネルの不安定性**
  - 断続的な切断:
  - パケットロス率が高い:
  - ハンドシェイク失敗:

- [ ] **DNS伝播の遅延**
  - TTL期間中の挙動:
  - 一部のリゾルバーがキャッシュ:
  - DNS Providerの障害:

### Control Plane障害

- [ ] **Control Plane自体がダウンした場合**
  - Edge Nodeの挙動:
  - Origin Serverの挙動:
  - 既存トラフィックへの影響:
  - 復旧手順:

- [ ] **データベース障害**
  - DBが一時的にダウン:
  - DBが破損:
  - バックアップからのリストア:

- [ ] **ディスク容量不足**
  - ログファイルの肥大化:
  - DBの肥大化:
  - 自動クリーンアップ:

### 証明書関連

- [ ] **SSL証明書期限切れ**
  - 検知方法:
  - 事前アラート（何日前？）:
  - 自動更新失敗時の対応:
  - 手動更新手順:

- [ ] **Let's Encrypt Rate Limit到達**
  - 対策:
  - フォールバック:

- [ ] **証明書配布失敗**
  - 一部ノードのみ失敗:
  - 全ノード失敗:
  - リトライロジック:

### VPS Provider関連

- [ ] **VPS作成失敗**
  - API呼び出し失敗:
  - クォータ超過:
  - リージョン選択ミス:
  - 決済エラー:

- [ ] **VPS削除失敗**
  - API呼び出し失敗:
  - VPSが既に削除済み:
  - 課金が継続してしまう:

- [ ] **Provider障害**
  - 一時的なAPI停止:
  - リージョン全体の障害:
  - アカウント停止:

### オリジンサーバー障害

- [ ] **Origin Serverの完全停止**
  - Edge Nodeの挙動:
  - エラーページ表示:
  - ユーザーへの通知:

- [ ] **バックエンドアプリの障害**
  - 一部サービスのみ停止:
  - 全サービス停止:
  - ヘルスチェックの挙動:

### 同時実行・競合

- [ ] **複数の管理者が同時操作**
  - 同じノードを同時削除:
  - 設定を同時変更:
  - 楽観的ロック/悲観的ロック:

- [ ] **自動処理と手動操作の競合**
  - 自動フェイルオーバー中に手動削除:
  - 自動復旧中に手動で設定変更:

---

## 7. 運用設計

### バックアップ・リストア

- [ ] **バックアップ対象**
  - Control Plane DB: ___
  - WireGuard鍵ペア: ___
  - 設定ファイル: ___
  - SSL証明書: ___
  - ログ: ___

- [ ] **バックアップ方法**
  - 手動/自動: ___
  - 頻度: ___
  - 保存先: ___
  - 暗号化: ___
  - 世代管理: ___

- [ ] **リストア手順**
  1. ___
  2. ___
  3. ___

- [ ] **リストアテスト**
  - 頻度: ___
  - 手順: ___

### ログ管理

- [ ] **ログ種別**
  - アクセスログ: 保存期間 ___ 、形式 ___
  - エラーログ: 保存期間 ___ 、形式 ___
  - 監査ログ: 保存期間 ___ 、形式 ___
  - システムログ: 保存期間 ___ 、形式 ___

- [ ] **ログ集約**
  - 方法: ___ (例: Loki / ELK / CloudWatch)
  - 検索機能: ___
  - アラート設定: ___

- [ ] **ログローテーション**
  - 方法: ___
  - 圧縮: ___
  - アーカイブ: ___

### アラート設計

- [ ] **アラート通知先**
  - Email: ___
  - Slack/Discord: ___
  - SMS: ___
  - PagerDuty: ___

- [ ] **アラート種別と優先度**
  - 🔴 Critical:
    - Edge Node全停止
    - Origin Server停止
    - Control Plane停止
    - ___
  - 🟠 Warning:
    - Edge Node 1台停止
    - ヘルスチェック失敗
    - 証明書期限30日前
    - ___
  - 🟡 Info:
    - ノード追加完了
    - 設定変更完了
    - ___

- [ ] **アラート抑制**
  - メンテナンス中: ___
  - 重複アラート: ___
  - エスカレーション: ___

### 監視項目

- [ ] **インフラ監視**
  - CPU使用率: 閾値 ___
  - メモリ使用率: 閾値 ___
  - ディスク使用率: 閾値 ___
  - ネットワーク帯域: 閾値 ___

- [ ] **アプリケーション監視**
  - API応答時間: 閾値 ___
  - エラーレート: 閾値 ___
  - リクエスト数: 閾値 ___
  - 同時接続数: 閾値 ___

- [ ] **ビジネスメトリクス**
  - 稼働中エッジノード数: 閾値 ___
  - トンネル接続成功率: 閾値 ___
  - DNS応答時間: 閾値 ___
  - 月間コスト: 閾値 ___

### メンテナンス

- [ ] **定期メンテナンス項目**
  - 週次:
  - 月次:
  - 四半期:
  - 年次:

- [ ] **緊急メンテナンス手順**
  1. ___
  2. ___
  3. ___

- [ ] **メンテナンス通知**
  - 事前通知期間: ___
  - 通知方法: ___

---

## 8. その他の検討事項

### コスト管理

- [ ] **コスト試算**
  - Control Plane: ___ USD/月
  - Edge Node × 3台: ___ USD/月
  - DNS Provider: ___ USD/月
  - SSL証明書: ___ USD/月
  - 合計想定コスト: ___ USD/月

- [ ] **コスト最適化**
  - 無料枠の活用: ___
  - リザーブドインスタンス: ___
  - スポットインスタンス: ___

### コンプライアンス・法的要件

- [ ] **データ保存場所の制約**
  - 個人情報: ___
  - ログ: ___
  - バックアップ: ___

- [ ] **GDPR/個人情報保護法対応**
  - データ削除要求: ___
  - データポータビリティ: ___
  - 同意管理: ___

- [ ] **監査ログ要件**
  - 保存期間: ___
  - 改ざん防止: ___
  - アクセス制御: ___

### ドキュメント

- [ ] **必要なドキュメント**
  - [ ] インストールガイド
  - [ ] 運用マニュアル
  - [ ] トラブルシューティングガイド
  - [ ] API リファレンス
  - [ ] アーキテクチャ設計書
  - [ ] セキュリティガイドライン
  - [ ] 障害対応手順書

---

## 進捗管理

| セクション | 着手日 | 完了日 | 担当 | ステータス |
|-----------|--------|--------|------|-----------|
| 1. ユースケース定義 | | | | ⬜ 未着手 |
| 2. 機能要件 | | | | ⬜ 未着手 |
| 3. 非機能要件 | | | | ⬜ 未着手 |
| 4. UI/UXフロー | | | | ⬜ 未着手 |
| 5. データフロー・状態遷移 | | | | ⬜ 未着手 |
| 6. エッジケース・異常系 | | | | ⬜ 未着手 |
| 7. 運用設計 | | | | ⬜ 未着手 |
| 8. その他の検討事項 | | | | ⬜ 未着手 |

---

## 次のアクション

- [ ] このドキュメントを順次埋めていく
- [ ] 不明点・検討事項をリストアップ
- [ ] 技術的な調査が必要な項目を特定
- [ ] プロトタイプで検証すべき項目を特定
