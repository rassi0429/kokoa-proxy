# kokoa-proxy - Project Plan Issues and Clarifications

このドキュメントは、kokoa-proxyプロジェクトの`spec.md`および`architecture.md`で特定された潜在的な問題、曖昧さ、明確化が必要な領域をまとめたものです。

## 1. 「防弾ホスティング」とフェイルオーバー自動化の明確化

*   **自動フェイルオーバーの矛盾**: `spec.md`では「自動フェイルオーバー（手動でも可）」と記述されていますが、その後「自動フェイルオーバーは手動実装が必要」がトレードオフとして挙げられています。`architecture.md`では、コントロールプレーンのヘルスチェッカーモジュールを介した自動DNSフェイルオーバーが明確化されていますが、攻撃されたVPSの実際の破壊と再作成は、別の自動化スクリプトまたは手動コマンドによってトリガーされるようです。
    *   **推奨事項**: 「防弾ホスティング」のスコープを明確に定義してください。フェイルオーバーのどの側面（例：DNS更新、トラフィックリダイレクト）が完全に自動化されているか、人間による介入（例：VPSの破壊/再作成の開始）または別の、まだ詳細に記述されていない自動化レイヤーが必要な側面を明示的に記述してください。

## 2. 詳細なヘルスチェック戦略

*   **ヘルスチェック構成の詳細**: `architecture.md`ではヘルスチェッカーモジュールとそのAPI（HTTP、TCP、ICMP、カスタムスクリプト）が導入され、アクティブチェックとパッシブハートビートの区別がされていますが、コントロールプレーンが各エッジノードとオリジンに対してこれらのチェックをどのように具体的に構成および登録するのかは完全に詳細に記述されていません。
    *   **推奨事項**: コントロールプレーンが各エッジノード（例：Nginxの稼働状況、WireGuardトンネルの状態、特定のヘルスエンドポイントの検証）とオリジン（例：アプリケーション固有のヘルスチェック）に対して*何を*チェックするかを決定し、構成するメカニズムを詳しく説明してください。

## 3. APIトークンと資格情報の安全な管理

*   **資格情報管理の一貫性の欠如**: `spec.md`ではAPIトークンが直接ファイル（`~/.secrets/cloudflare.ini`）に表示されています。`architecture.md`のKubernetesの例ではシークレットが使用されていますが、`docker-compose.yml`の例では`.env`ファイルからの環境変数に依存しています。これは、機密データに対する一貫性のないアプローチを示しています。
    *   **推奨事項**: プロジェクトは、すべてのデプロイシナリオで機密性の高い資格情報を管理するための一貫した強力な推奨事項を必要としています。本番環境では、プレーンなファイルや緩やかに管理された環境変数ではなく、専用のシークレット管理ソリューション（例：Kubernetes Secrets、HashiCorp Vault、クラウドプロバイダーのシークレットマネージャー）を強調してください。

## 4. DDoS軽減の制限とスコープ

*   **NginxベースのDDoS保護の限界**: 両方のドキュメントでDDoS軽減のためにNginxの`limit_req_zone`が言及されています。これは基本的なレイヤー7保護を提供します。しかし、大規模でボリュームのあるDDoS攻撃に対しては、Nginxがリクエストを処理する前にVPS自体が圧倒される可能性があるため、不十分かもしれません。
    *   **推奨事項**: DDoS保護のスコープを明確に定義してください。Nginxの機能は主にアプリケーションレベルのDDoSまたは小規模な攻撃用であり、より深刻でボリュームのある攻撃には外部の専門的なDDoS軽減サービスが必要になる可能性があることを認識してください。

## 5. `client_max_body_size`のセキュリティ上の影響

*   **リソース枯渇の可能性**: Nginx設定（`spec.md`より）の大きな`client_max_body_size 500M`は、バックエンドアプリケーションが非常に大きなアップロードを効率的に処理するように設計されていない場合、リソース枯渇攻撃に悪用される可能性があります。
    *   **推奨事項**: これを潜在的なセキュリティ上の懸念として指摘し、特定のアプリケーション要件とバックエンド機能に基づいてこの値を調整することを推奨するべきです。

## 6. Cloudflareオリジン証明書と「プロキシOFF」の矛盾

*   **SSL/TLS戦略の矛盾**: `spec.md`はCloudflareオリジン証明書の使用を提案していますが、その後「CloudflareはDNSのみで利用（プロキシOFF）」を推奨し、さらに「Cloudflare IPからのみアクセス許可」にアクセスを制限しています。Cloudflareプロキシがオフの場合、トラフィックはCloudflare IPからは発生しないため、IP制限は無効になり、オリジン証明書はエッジノードを介したエンドユーザーからオリジンへのエンドツーエンド暗号化には不適切です。
    *   **推奨事項**: この矛盾を明確にしてください。もし目標がCloudflareのプロキシに依存しないセルフホストである場合、Cloudflareオリジン証明書は、Cloudflareのプロキシがアクティブである場合、または異なる明確に定義された目的（例：Cloudflareを経由しないトラフィックのエッジからオリジンへの内部利用のセキュリティ確保）のためにのみ考慮されるべきです。そうでなければ、他のSSLオプションを優先すべきです。

## 7. `proxy_protocol`の使用推奨

*   **「オプション」ステータスの曖昧さ**: Nginx（`spec.md`より）の`proxy_protocol on;`ディレクティブは「オプション」とマークされています。しかし、バックエンドアプリケーションでの正確なクライアントIPアドレスのロギング、レート制限、およびセキュリティ機能のためには、プロキシ（エッジノード上のNginxなど）がTCP接続を終端する場合、`proxy_protocol`は一般的に不可欠です。
    *   **推奨事項**: 「オプション」ステータスを再評価してください。ほとんどのユースケースではより強く推奨されるべきであり、それが本当にオプションである特定のシナリオとその影響（例：実際のクライアントIPの損失）を詳細に記述すべきです。

## 8. VPSライフサイクル全体の完全な自動化

*   **自動化されたVPS交換ワークフローのギャップ**: `architecture.md`では`Edge Provisioner Module`が定義され、`spec.md`では`rotate-vps.sh`スクリプトが提供されていますが、「攻撃検出」から「VPSが交換されてオンラインになる」までの完全な自動化されたワークフローは、具体的な例やモジュール間の相互作用で完全に詳述されていません。
    *   **推奨事項**: 新しいVPSインスタンスでWireGuardとNginxを設定するためのAnsible/Cloud-initスクリプトと`Edge Provisioner Module`の統合を詳細に記述してください。VPS交換のためのより明確な、段階的なエンドツーエンドの自動化シーケンスを提供してください。

## 9. 非Kubernetesデプロイにおけるコントロールプレーンの高可用性

*   **スタンドアロンコントロールプレーンのHA戦略の欠如**: `architecture.md`ではコントロールプレーンの可用性について「高（冗長性推奨）」と記述されていますが、Kubernetesデプロイのみが`replicas: 2`を明示的に示しています。「All-in-One」の`docker-compose.yml`は単一のコントロールプレーンインスタンスを示唆しています。
    *   **推奨事項**: Kubernetes以外の本番ユースケースでは、システム全体のフェイルオーバーを管理するコントロールプレーンの重要な役割を考慮し、コントロールプレーンの代替HA戦略（例：共有データベースによるアクティブ-パッシブ、またはクラスター化されたセットアップ）に言及すべきです。

## 10. コントロールプレーンモジュールのスケーラビリティに関する考慮事項

*   **単一レプリカを超えるスケーラビリティの未定義**: モジュラー設計は独立したスケーリングを可能にしますが、`dns-manager`、`edge-provisioner`などのKubernetesデプロイの例では`replicas: 1`と表示されています。これらのモジュールは外部APIと対話することが多いですが、高負荷時（例：多数の迅速なVPSローテーション、頻繁な証明書更新）には内部処理ロジックがボトルネックになる可能性があります。
    *   **推奨事項**: これらのモジュールが本質的にステートレスであり、複雑な調整なしに水平方向に容易にスケールできるのか、それとも単一インスタンスを超えてスケーリングを複雑にする内部状態を持っているのかを明確にしてください。高負荷時にこれらのモジュールをスケーリングする方法に関するガイダンスを提供してください。